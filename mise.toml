min_version = "2024.9.5"

[tools]
node = "24.12.0"
pnpm = "10.26.0"

[env]
NODE_ENV = "development"
_.path = ["./node_modules/.bin"]

# Development environment - derived from [vars]
VITE_PORT = "{{vars.port}}"
VITE_API_PORT = "{{vars.api_port}}"
VITE_API_ROOT_URL = "http://localhost:{{vars.api_port}}"
VITE_PUBLIC_URL = "http://localhost:{{vars.port}}/public"

[vars]
# Port configuration (override in mise.local.toml for worktrees)
port = "8080"
api_port = "8000"

# Config paths
eslint_config = "./config/eslint.config.js"
prettier_config = "./config/.prettierrc"
stylelint_config = "./config/.stylelintrc.json"
vitest_config = "./config/vitest.config.ts"
playwright_config = "./config/playwright.config.ts"
steiger_config = "./config/steiger.config.ts"
releaserc = "./config/.releaserc.json"
knip_config = "./config/knip.config.ts"
depcruise_config = "./config/.dependency-cruiser.js"
cspell_config = "./config/cspell.json"
storybook_config = "./.storybook"
i18n_config = "./config/i18next-parser.config.ts"
lintstaged_config = "./config/.lintstagedrc"

[tasks.build]
description = "Build the application"
alias = "b"
run = "react-router build"
sources = ["src/**/*", "package.json", "vite.config.ts", "tsconfig.json"]
outputs = ["build/**/*", "build"]

[tasks.build_analyze]
description = "Analyze bundle size"
alias = "ba"
depends = ["build"]
run = "vite-bundle-analyzer"

[tasks.clean]
description = "Remove build artifacts and cache"
confirm = "This will delete dist, coverage, test results, and build caches. Continue?"
run = "rm -rf dist .vite coverage playwright-report test-results"

[tasks.depcruise]
description = "Check for circular dependencies and other dependency issues"
alias = "dc"
run = "depcruise src --config {{vars.depcruise_config}}"

[tasks.depcruise_graph]
description = "Generate visual dependency graph (requires graphviz)"
alias = "dcg"
run = "depcruise src --config {{vars.depcruise_config}} --output-type dot | dot -T svg > dependency-graph.svg && echo 'Generated: dependency-graph.svg'"

[tasks.dev]
description = "Start development server"
alias = "d"
run = "react-router dev"

[tasks.format]
description = "Format code with Prettier"
alias = "f"
run = "prettier --write \"**/*.{ts,tsx,css}\" --config {{vars.prettier_config}}"

[tasks.lint]
description = "Run ESLint"
alias = "l"
run = "eslint . --ext .ts,.tsx --config {{vars.eslint_config}} --max-warnings 0"

[tasks.lintstaged]
description = "Run lint-staged on staged files"
run = "lint-staged --config {{vars.lintstaged_config}}"

[tasks.knip]
description = "Find unused files, dependencies, and exports"
alias = "k"
run = "knip --config {{vars.knip_config}} --no-config-hints"

[tasks.knip_fix]
description = "Auto-remove unused exports"
alias = "kf"
run = "knip --config {{vars.knip_config}} --fix --no-config-hints"

[tasks.preview]
description = "Preview production build"
alias = "p"
depends = ["build"]
run = "react-router preview"

[tasks.spell]
description = "Check spelling with cspell"
alias = "sp"
run = "cspell . --config {{vars.cspell_config}}"

[tasks.semantic_release]
description = "Create a new release using semantic-release"
alias = "release"
confirm = "This will create a new release. Continue?"
run = "semantic-release -c {{vars.releaserc}}"

[tasks.steiger]
description = "Run Steiger architecture linter"
run = "steiger ./src --config {{vars.steiger_config}}"

[tasks.steiger_fix]
description = "Run Steiger with auto-fix"
alias = "sf"
run = "steiger --fix ./src --config {{vars.steiger_config}}"

[tasks.stylelint]
description = "Run Stylelint for CSS/SCSS"
alias = "sl"
run = "stylelint \"**/*.{css,scss}\" --ignore-path .gitignore --config {{vars.stylelint_config}}"

[tasks.test]
description = "Run unit tests"
alias = "t"
depends = ["build"]
run = "vitest --config {{vars.vitest_config}}"

[tasks.test_coverage]
description = "Run tests with coverage"
alias = "tc"
depends = ["build"]
run = "vitest run --coverage --config {{vars.vitest_config}}"

[tasks.test_e2e]
description = "Run end-to-end tests with Playwright"
alias = "te"
depends = ["build"]
run = "playwright test --config {{vars.playwright_config}}"

[tasks.test_e2e_ui]
description = "Run E2E tests in UI mode"
alias = "teu"
run = "playwright test --ui --config {{vars.playwright_config}}"

[tasks.test_ui]
description = "Open Vitest UI"
alias = "tu"
depends = ["build"]
run = "vitest --ui --config {{vars.vitest_config}}"

[tasks.test_storybook]
description = "Run Storybook component tests"
alias = "tsb"
run = "vitest --config {{vars.storybook_config}}/vitest.config.ts"

[tasks.typegen]
description = "Generate React Router route types"
run = "react-router typegen"

[tasks.typecheck]
description = "Run TypeScript type checking"
alias = "tt"
depends = ["typegen"]
run = "tsc --noEmit"

[tasks.storybook]
description = "Start Storybook dev server"
alias = "sb"
run = "storybook dev -p 6006 --config-dir {{vars.storybook_config}}"

[tasks.storybook_build]
description = "Build Storybook static site"
alias = "sbb"
run = "storybook build -o storybook-static --config-dir {{vars.storybook_config}}"

[tasks.i18n_check]
description = "Extract and validate translation keys"
alias = "i18n"
run = "i18next --config {{vars.i18n_config}}"
