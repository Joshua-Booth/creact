min_version = "2024.9.5"

[tools]
node = "24.12.0"
pnpm = "10.28.0"

[env]
NODE_ENV = "development"
_.path = ["./node_modules/.bin"]

# Optional: Set in mise.local.toml for Sentry error tracking
# VITE_SENTRY_DSN = "your_sentry_dsn"

# Development environment - derived from [vars]
VITE_PORT = "{{vars.port}}"
VITE_API_PORT = "{{vars.api_port}}"
VITE_API_ROOT_URL = "http://localhost:{{vars.api_port}}"
VITE_PUBLIC_URL = "http://localhost:{{vars.port}}/public"

[vars]
# Port configuration (override in mise.local.toml for worktrees)
port = "8080"
api_port = "8000"

# Config paths
eslint_config = "./config/eslint.config.js"
prettier_config = "./config/.prettierrc"
prettier_ignore = "./config/.prettierignore"
stylelint_config = "./config/.stylelintrc.json"
playwright_config = "./config/playwright.config.ts"
steiger_config = "./config/steiger.config.ts"
releaserc = "./config/.releaserc.json"
knip_config = "./config/knip.config.ts"
depcruise_config = "./config/.dependency-cruiser.js"
cspell_config = "./config/cspell.json"
storybook_config = "./.storybook"
lintstaged_config = "./config/.lintstagedrc"

[tasks.build]
description = "Build the application"
alias = "b"
run = "react-router build"
sources = ["src/**/*", "package.json", "vite.config.ts", "tsconfig.json"]
outputs = ["dist/**/*"]

[tasks.build_e2e]
description = "Build for e2e testing (standard Node server)"
alias = "be"
env = { E2E = "true" }
run = "react-router build"

[tasks.build_e2e_coverage]
description = "Build for e2e testing with coverage instrumentation"
env = { E2E = "true", COVERAGE = "true" }
run = "react-router build"

[tasks.build_analyze]
description = "Analyze bundle size"
alias = "ba"
depends = ["build"]
run = "vite-bundle-analyzer"

[tasks.clean]
description = "Remove build artifacts and cache"
confirm = "This will delete dist, coverage, test results, and build caches. Continue?"
run = "rm -rf dist .vite coverage playwright-report test-results"

[tasks.depcruise]
description = "Check for circular dependencies and other dependency issues"
alias = "dc"
run = "depcruise src --config {{vars.depcruise_config}}"

[tasks.depcruise_graph]
description = "Generate visual dependency graph (requires graphviz)"
alias = "dcg"
run = "depcruise src --config {{vars.depcruise_config}} --output-type dot | dot -T svg > dependency-graph.svg && echo 'Generated: dependency-graph.svg'"

[tasks.dev]
description = "Start development server"
alias = "d"
run = "react-router dev"

[tasks.generate]
description = "Scaffold FSD slices and components"
alias = "g"
run = "pnpm exec plop --plopfile config/plopfile.ts --dest ."

[tasks.format]
description = "Format code with Prettier"
alias = "f"
run = "prettier --write \"**/*.{ts,tsx,js,css,json,yml,yaml}\" --config {{vars.prettier_config}} --ignore-path {{vars.prettier_ignore}}"

[tasks.format_files]
description = "Format specific files (for lint-staged)"
run = "prettier --config {{vars.prettier_config}} --ignore-path {{vars.prettier_ignore}} --write"

[tasks.format_check]
description = "Check code formatting with Prettier"
alias = "fc"
run = "prettier --check \"**/*.{ts,tsx,js,css,json,yml,yaml}\" --config {{vars.prettier_config}} --ignore-path {{vars.prettier_ignore}}"

[tasks.lint]
description = "Fix code with ESLint"
alias = "l"
depends = ["typegen"]
run = "eslint . --ext .ts,.tsx --config {{vars.eslint_config}} --max-warnings 0 --fix"

[tasks.lint_files]
description = "Lint specific files (for lint-staged)"
run = "eslint --config {{vars.eslint_config}} --fix"

[tasks.lint_check]
description = "Check code with ESLint"
alias = "lc"
depends = ["typegen"]
run = "eslint . --ext .ts,.tsx --config {{vars.eslint_config}} --max-warnings 0"

[tasks.lintstaged]
description = "Run lint-staged on staged files"
run = "lint-staged --config {{vars.lintstaged_config}}"

[tasks.knip]
description = "Find unused files, dependencies, and exports"
alias = "k"
run = "knip --config {{vars.knip_config}} --no-config-hints"

[tasks.knip_fix]
description = "Auto-remove unused exports"
alias = "kf"
run = "knip --config {{vars.knip_config}} --fix --no-config-hints"

[tasks.preview]
description = "Preview production build"
alias = "p"
depends = ["build"]
run = "vite preview --config config/vite.config.ts"

[tasks.spell]
description = "Check spelling with cspell"
alias = "sp"
run = "cspell . --config {{vars.cspell_config}}"

[tasks.spell_files]
description = "Spell check specific files (for lint-staged)"
run = "cspell --config {{vars.cspell_config}} --no-must-find-files"

[tasks.semantic_release]
description = "Create a new release using semantic-release"
alias = "release"
confirm = "This will create a new release. Continue?"
run = "semantic-release -c {{vars.releaserc}}"

[tasks.steiger]
description = "Run Steiger architecture linter"
run = "steiger ./src --config {{vars.steiger_config}}"

[tasks.steiger_fix]
description = "Run Steiger with auto-fix"
alias = "sf"
run = "steiger --fix ./src --config {{vars.steiger_config}}"

[tasks.stylelint]
description = "Fix CSS/SCSS with Stylelint"
alias = "sl"
run = "stylelint \"**/*.{css,scss}\" --ignore-path .gitignore --config {{vars.stylelint_config}} --fix"

[tasks.stylelint_files]
description = "Lint specific CSS files (for lint-staged)"
run = "stylelint --config {{vars.stylelint_config}} --fix"

[tasks.stylelint_check]
description = "Check CSS/SCSS with Stylelint"
alias = "slc"
run = "stylelint \"**/*.{css,scss}\" --ignore-path .gitignore --config {{vars.stylelint_config}}"

[tasks.test]
description = "Run unit and Storybook tests"
alias = "t"
depends = ["build"]
run = "vitest"

[tasks.test_unit]
description = "Run unit tests only"
alias = "tu"
depends = ["build"]
run = "vitest --project unit"

[tasks.test_coverage]
description = "Run unit and Storybook tests with coverage"
alias = "tc"
depends = ["build"]
run = "vitest run --coverage.enabled"

[tasks.test_e2e]
description = "Run end-to-end tests with Playwright"
alias = "te"
depends = ["build_e2e"]
run = "playwright test --config {{vars.playwright_config}}"

[tasks.test_e2e_ui]
description = "Run E2E tests in UI mode"
alias = "teu"
depends = ["build_e2e"]
run = "playwright test --ui --config {{vars.playwright_config}}"

[tasks.test_e2e_coverage]
description = "Run E2E tests with coverage"
alias = "tec"
depends = ["build_e2e_coverage"]
env = { COVERAGE = "true" }
run = "playwright test --config {{vars.playwright_config}}"

[tasks.test_coverage_merge]
description = "Merge coverage reports from all test suites"
alias = "tcm"
run = "node scripts/merge-coverage.ts"

[tasks.test_coverage_all]
description = "Run all tests with coverage and merge reports"
alias = "tca"
depends = ["test_coverage", "test_e2e_coverage"]
run = "mise run test_coverage_merge"

[tasks.test_coverage_serve]
description = "Serve the merged coverage report"
alias = "tcs"
run = "npx serve coverage/merged/html -p 9123"

[tasks.test_ui]
description = "Open Vitest UI"
alias = "tui"
depends = ["build"]
run = "vitest --ui"

[tasks.test_storybook]
description = "Run Storybook component tests"
alias = "tsb"
run = "vitest --config {{vars.storybook_config}}/vitest.config.ts"

[tasks.typegen]
description = "Generate React Router route types"
run = "react-router typegen"

[tasks.typecheck]
description = "Run TypeScript type checking"
alias = "tt"
depends = ["typegen"]
run = "tsc --noEmit && tsc --noEmit --project config/tsconfig.node.json"

[tasks.storybook]
description = "Start Storybook dev server"
alias = "sb"
run = "storybook dev -p 6006 --config-dir {{vars.storybook_config}}"

[tasks.storybook_build]
description = "Build Storybook static site"
alias = "sbb"
run = "storybook build -o storybook-static --config-dir {{vars.storybook_config}}"

[tasks.check]
description = "Run all CI checks locally"
alias = "c"
depends = [
    "format_check",
    "lint_check",
    "stylelint_check",
    "typecheck",
    "test_coverage",
    "test_e2e",
    "storybook_build",
    "knip",
    "depcruise",
    "steiger",
    "spell",
]
run = "echo 'All checks passed!'"
